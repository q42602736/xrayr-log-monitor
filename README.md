# XrayR日志监控一体化脚本

🚀 功能完整的XrayR日志文件自动清理和管理系统

## 功能特性

✅ **一体化管理** - 安装、卸载、状态查看、手动清理全功能  
✅ **自定义大小** - 可设置50MB-1000MB或自定义日志文件大小限制  
✅ **智能清理** - 超过设定大小时自动备份并清理日志  
✅ **自动重启** - 支持systemctl和xrayr命令两种重启方式  
✅ **灵活定时** - 可配置检查频率（每15分钟到每小时或自定义分钟数）  
✅ **状态监控** - 实时查看监控状态、服务状态、日志大小等  
✅ **日志管理** - 查看清理日志、实时监控日志变化  
✅ **安全可靠** - 完善的错误处理和权限检查  
✅ **用户友好** - 彩色界面、交互式菜单、详细提示  

## 快速开始

### 下载并运行（推荐）
```bash
wget https://raw.githubusercontent.com/q42602736/xrayr-log-monitor/main/xrayr_monitor.sh
chmod +x xrayr_monitor.sh
sudo ./xrayr_monitor.sh
```

## 主菜单功能

运行脚本后会显示交互式菜单：

```
╔════════════════════════════════════════╗
║        XrayR日志监控管理脚本           ║
╚════════════════════════════════════════╝

请选择操作:
1) 安装XrayR日志监控
2) 卸载XrayR日志监控  
3) 查看监控状态
4) 手动执行清理
5) 查看清理日志
0) 退出
```

### 1. 安装XrayR日志监控

**配置选项**：

#### 文件大小限制
- 50MB
- 100MB (推荐)
- 200MB
- 500MB
- 自定义 (1-1000MB)

#### 重启方式
- **systemctl重启** (推荐) - 更稳定可靠
- **xrayr命令重启** - 模拟手动操作，需要expect工具

#### 检查频率
- 每小时检查一次 (默认)
- 每30分钟检查一次
- 每15分钟检查一次
- 自定义间隔 - 直接输入分钟数 (1-59分钟)

### 2. 卸载XrayR日志监控

- 删除所有脚本和定时任务
- 可选择保留或删除日志文件
- 可选择保留或删除备份文件

### 3. 查看监控状态

实时显示系统状态：
- ✅ 安装状态
- ✅ 监控脚本状态
- ✅ 定时任务状态
- ✅ XrayR日志文件大小
- ✅ XrayR服务运行状态
- ✅ 清理日志状态
- ✅ 备份文件数量
- 📋 最近清理记录

### 4. 手动执行清理

- 立即执行一次日志清理检查
- 实时显示清理过程
- 安全确认机制

### 5. 查看清理日志

多种查看方式：
- 查看最近20行
- 查看全部日志
- 实时监控日志

## 系统要求

- **操作系统**: Debian/Ubuntu (其他Linux发行版可能需要调整)
- **权限**: 需要root权限
- **依赖**: 已安装XrayR
- **可选**: expect工具 (如果选择使用xrayr命令重启)

## 文件结构

安装后会创建以下文件：

```
/root/xrayr_monitor/
├── xrayr_log_cleanup.sh    # 主监控脚本
└── xrayr_restart.exp       # expect重启脚本(可选)

/var/log/
└── xrayr_cleanup.log       # 操作日志

/etc/XrayR/
├── access.Log              # 监控的访问日志文件
├── error.log               # 监控的错误日志文件
├── access.log.backup.*     # 访问日志备份文件
└── error.log.backup.*      # 错误日志备份文件
```

## 常用命令

```bash
# 运行管理脚本
sudo ./xrayr_monitor.sh

# 手动运行清理检查
/root/xrayr_monitor/xrayr_log_cleanup.sh

# 查看清理日志
tail -f /var/log/xrayr_cleanup.log

# 查看定时任务
crontab -l

# 查看XrayR服务状态
systemctl status XrayR
```

## 工作原理

1. **定时检查** - 通过crontab定时运行监控脚本
2. **双文件监控** - 同时检查`/etc/XrayR/access.Log`和`/etc/XrayR/error.log`文件大小
3. **自动备份** - 超过设定大小时先备份原文件
4. **智能清理** - 清空超大日志文件释放空间
5. **重启服务** - 任一文件被清理后自动重启XrayR服务
6. **记录日志** - 所有操作记录到`/var/log/xrayr_cleanup.log`

## 特色功能

### 🎨 彩色界面
- 绿色：成功信息
- 黄色：警告信息  
- 红色：错误信息
- 蓝色：标题信息
- 青色：提示信息

### 🔧 智能配置
- 自动检测系统环境
- 输入验证和错误处理
- 默认值和智能建议
- 安全确认机制

### 📊 状态监控
- 实时系统状态显示
- 详细的组件检查
- 历史操作记录
- 文件大小监控

### 🛡️ 安全特性
- Root权限检查
- 操作确认机制
- 完整的错误处理
- 安全的文件操作

## 故障排除

### 常见问题

**Q: 脚本运行后没有效果？**
A: 
1. 确保以root权限运行
2. 检查XrayR日志文件路径是否正确
3. 查看操作日志：`tail -f /var/log/xrayr_cleanup.log`
4. 使用"查看监控状态"功能检查配置

**Q: XrayR服务重启失败？**
A:
1. 检查XrayR服务状态：`systemctl status XrayR`
2. 确认服务名称是否正确
3. 检查服务配置文件
4. 尝试手动重启：`systemctl restart XrayR`

**Q: 定时任务没有执行？**
A:
1. 检查crontab设置：`crontab -l | grep xrayr`
2. 查看系统日志：`journalctl -u cron`
3. 确认脚本有执行权限

## 更新日志

### v2.1.0 (双日志监控版本)
- 🆕 同时监控access.Log和error.log两个日志文件
- 🆕 独立的日志文件大小检查和清理
- 🆕 分别备份不同类型的日志文件
- 🆕 智能重启：任一文件被清理后重启服务
- 🆕 详细的状态显示和备份文件统计

### v2.0.0 (一体化版本)
- 🆕 一体化管理界面
- 🆕 自定义文件大小限制
- 🆕 状态监控功能
- 🆕 日志管理功能
- 🆕 彩色交互界面
- 🆕 完整的卸载功能

### v1.0.0
- 初始版本发布
- 支持自动日志清理和服务重启
- 一键安装脚本

## 许可证

MIT License
